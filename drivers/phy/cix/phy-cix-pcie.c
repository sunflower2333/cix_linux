// SPDX-License-Identifier: GPL-2.0

#include <linux/clk.h>
#include <linux/clk-provider.h>
#include <linux/delay.h>
#include <linux/err.h>
#include <linux/io.h>
#include <linux/module.h>
#include <linux/phy/phy.h>
#include <linux/platform_device.h>
#include <linux/pm_runtime.h>
#include <linux/regmap.h>
#include <linux/reset.h>
#include <linux/of.h>
#include <linux/of_platform.h>

#define MAX_LANES 8
#define X8 8
#define X4 4

enum {
	LINK_INVALID = 0,
	LINK_ENABLED,
	LINK_DISABLED
};

static const struct reg_sequence pcie_x8[] = {
	{ 0xC003, 0x0144, 0 }, { 0xE000, 0x0040, 0 }, { 0x0050, 0x8804, 0 },
	{ 0x0062, 0x1219, 0 }, { 0x6002, 0x55A0, 0 }, { 0x6003, 0x691f, 0 },
	{ 0x600C, 0x001D, 0 }, { 0x604B, 0x0143, 0 }, { 0x6081, 0x813E, 0 },
	{ 0x6083, 0x4000, 0 }, { 0x6085, 0x1978, 0 }, { 0x6086, 0x0389, 0 },
	{ 0x6088, 0x038C, 0 }, { 0x608E, 0x3A7A, 0 }, { 0x6091, 0x033C, 0 },
	{ 0x6093, 0x0000, 0 }, { 0x6096, 0x0003, 0 }, { 0x6097, 0x22CC, 0 },
	{ 0x60AA, 0x7FF6, 0 }, { 0x60AB, 0x7FF6, 0 }, { 0x60B0, 0x7FBF, 0 },
	{ 0x60B1, 0x7FBF, 0 }, { 0x60B2, 0x7FD8, 0 }, { 0x60D4, 0x8C67, 0 },
	{ 0x60D5, 0x8C67, 0 }, { 0x60DE, 0x2437, 0 }, { 0x60E2, 0x3C2C, 0 },
	{ 0x60E8, 0x0000, 0 }, { 0x60EA, 0x0203, 0 }, { 0x60E8, 0x0001, 0 },
	{ 0x60EA, 0x0403, 0 }, { 0x60E8, 0x0002, 0 }, { 0x60EA, 0x0603, 0 },
	{ 0x60E8, 0x0003, 0 }, { 0x60EA, 0x0803, 0 }, { 0x60E8, 0x0004, 0 },
	{ 0x60EA, 0x0A03, 0 }, { 0x60E8, 0x0005, 0 }, { 0x60EA, 0x0C03, 0 },
	{ 0x60E8, 0x0006, 0 }, { 0x60EA, 0x0E03, 0 }, { 0x60E8, 0x0007, 0 },
	{ 0x60EA, 0x0F03, 0 }, { 0x60E8, 0x0008, 0 }, { 0x60EA, 0x1003, 0 },
	{ 0x60E8, 0x0009, 0 }, { 0x60EA, 0x1103, 0 }, { 0x60E8, 0x000A, 0 },
	{ 0x60E9, 0x1E06, 0 }, { 0x60EA, 0x1203, 0 }, { 0x60E8, 0x000B, 0 },
	{ 0x60EA, 0x1303, 0 }, { 0x60E8, 0x000C, 0 }, { 0x60EA, 0x1403, 0 },
	{ 0x60E8, 0x000D, 0 }, { 0x60EA, 0x1503, 0 }, { 0x60E8, 0x000E, 0 },
	{ 0x60E9, 0x2A06, 0 }, { 0x60EA, 0x1603, 0 }, { 0x60E8, 0x000F, 0 },
	{ 0x60E9, 0x2D06, 0 }, { 0x60EA, 0x1703, 0 }, { 0x60E8, 0x0010, 0 },
	{ 0x60E9, 0x2E06, 0 }, { 0x60EA, 0x1803, 0 }, { 0x60E8, 0x0011, 0 },
	{ 0x60EA, 0x1903, 0 }, { 0x60E8, 0x0012, 0 }, { 0x60E9, 0x3006, 0 },
	{ 0x60EA, 0x1A03, 0 }, { 0x60E8, 0x0013, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1B03, 0 }, { 0x60E8, 0x0014, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1C03, 0 }, { 0x60E8, 0x0015, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1D03, 0 }, { 0x60E8, 0x0016, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1E03, 0 }, { 0x60E8, 0x0017, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1F03, 0 }, { 0x60E8, 0x0018, 0 }, { 0x60E9, 0x3206, 0 },
	{ 0x60EA, 0x2003, 0 }, { 0x60E8, 0x0019, 0 }, { 0x60E9, 0x3306, 0 },
	{ 0x60EA, 0x2103, 0 }, { 0x60E8, 0x001A, 0 }, { 0x60E9, 0x3606, 0 },
	{ 0x60EA, 0x2203, 0 }, { 0x60E8, 0x001B, 0 }, { 0x60E9, 0x3906, 0 },
	{ 0x60EA, 0x2303, 0 }, { 0x60E8, 0x001C, 0 }, { 0x60E9, 0x3B06, 0 },
	{ 0x60EA, 0x2403, 0 }, { 0x60E8, 0x001D, 0 }, { 0x60E9, 0x3F06, 0 },
	{ 0x60EA, 0x2603, 0 }, { 0x60E8, 0x001E, 0 }, { 0x60E9, 0x4306, 0 },
	{ 0x60EA, 0x2803, 0 }, { 0x60E8, 0x001F, 0 }, { 0x60E9, 0x4706, 0 },
	{ 0x60EA, 0x2A03, 0 }, { 0x60F5, 0x1560, 0 }, { 0x60F8, 0x1560, 0 },
	{ 0x60FA, 0x00BC, 0 }, { 0x60FB, 0x00A6, 0 }, { 0x60FC, 0x01B6, 0 },
	{ 0x60FF, 0x0333, 0 }, { 0x6100, 0x0738, 0 }, { 0x6101, 0x0665, 0 },
	{ 0x6102, 0x09AC, 0 }, { 0x6103, 0x0888, 0 }, { 0x6104, 0x0CDD, 0 },
	{ 0x6105, 0x0888, 0 }, { 0x6106, 0x0CDD, 0 }, { 0x6107, 0x0888, 0 },
	{ 0x6108, 0x0CDD, 0 }, { 0x6109, 0x0888, 0 }, { 0x610A, 0x0CDD, 0 },
	{ 0x610B, 0x0599, 0 }, { 0x610C, 0x0DFE, 0 }, { 0x610E, 0x0599, 0 },
	{ 0x610F, 0x0DEE, 0 }, { 0x6111, 0x28FF, 0 }, { 0x6117, 0x1D3A, 0 },
	{ 0x6118, 0x1B36, 0 }, { 0x611B, 0x000F, 0 }, { 0x611C, 0x0002, 0 },
	{ 0x611D, 0x0002, 0 }, { 0x611E, 0x003C, 0 }, { 0x6121, 0x001F, 0 },
	{ 0x6122, 0x1CE7, 0 }, { 0x6123, 0x1D67, 0 }, { 0x6128, 0x03F4, 0 },
	{ 0x614C, 0x0E04, 0 }, { 0x614D, 0x0101, 0 }, { 0x6150, 0x005A, 0 },
	{ 0x6153, 0x6A10, 0 }, { 0x6154, 0x0080, 0 }, { 0x6155, 0x0002, 0 },
	{ 0x6156, 0x0F21, 0 }, { 0x6157, 0x1F21, 0 }, { 0x6161, 0x0023, 0 },
	{ 0x617E, 0x0B24, 0 }, { 0x6190, 0x003F, 0 }, { 0x61F8, 0x0551, 0 },
	{ 0x61F9, 0x0022, 0 }, { 0x61FA, 0x0010, 0 }, { 0x61FB, 0x0010, 0 },
	{ 0x61FC, 0x0008, 0 }, { 0x61FE, 0x795B, 0 }
};

static const struct reg_sequence pcie_x4[] = {
	{ 0xC003, 0x0144, 0 }, { 0xE000, 0x0040, 0 }, { 0x0050, 0x8804, 0 },
	{ 0x0062, 0x1219, 0 }, { 0x6002, 0x55A0, 0 }, { 0x6003, 0x691f, 0 },
	{ 0x600C, 0x001D, 0 }, { 0x604B, 0x0143, 0 }, { 0x6081, 0x813E, 0 },
	{ 0x6083, 0x4000, 0 }, { 0x6085, 0x1978, 0 }, { 0x6086, 0x0389, 0 },
	{ 0x6088, 0x038C, 0 }, { 0x608E, 0x3A7A, 0 }, { 0x6091, 0x033C, 0 },
	{ 0x6093, 0x0000, 0 }, { 0x6096, 0x0003, 0 }, { 0x6097, 0x22CC, 0 },
	{ 0x60AA, 0x7FF6, 0 }, { 0x60AB, 0x7FF6, 0 }, { 0x60B0, 0x7FBF, 0 },
	{ 0x60B1, 0x7FBF, 0 }, { 0x60B2, 0x7FD8, 0 }, { 0x60D4, 0x8C67, 0 },
	{ 0x60D5, 0x8C67, 0 }, { 0x60DE, 0x2437, 0 }, { 0x60E2, 0x3C2C, 0 },
	{ 0x60E8, 0x0000, 0 }, { 0x60EA, 0x0203, 0 }, { 0x60E8, 0x0001, 0 },
	{ 0x60EA, 0x0403, 0 }, { 0x60E8, 0x0002, 0 }, { 0x60EA, 0x0603, 0 },
	{ 0x60E8, 0x0003, 0 }, { 0x60EA, 0x0803, 0 }, { 0x60E8, 0x0004, 0 },
	{ 0x60EA, 0x0A03, 0 }, { 0x60E8, 0x0005, 0 }, { 0x60EA, 0x0C03, 0 },
	{ 0x60E8, 0x0006, 0 }, { 0x60EA, 0x0E03, 0 }, { 0x60E8, 0x0007, 0 },
	{ 0x60EA, 0x0F03, 0 }, { 0x60E8, 0x0008, 0 }, { 0x60EA, 0x1003, 0 },
	{ 0x60E8, 0x0009, 0 }, { 0x60EA, 0x1103, 0 }, { 0x60E8, 0x000A, 0 },
	{ 0x60E9, 0x1E06, 0 }, { 0x60EA, 0x1203, 0 }, { 0x60E8, 0x000B, 0 },
	{ 0x60EA, 0x1303, 0 }, { 0x60E8, 0x000C, 0 }, { 0x60EA, 0x1403, 0 },
	{ 0x60E8, 0x000D, 0 }, { 0x60EA, 0x1503, 0 }, { 0x60E8, 0x000E, 0 },
	{ 0x60E9, 0x2A06, 0 }, { 0x60EA, 0x1603, 0 }, { 0x60E8, 0x000F, 0 },
	{ 0x60E9, 0x2D06, 0 }, { 0x60EA, 0x1703, 0 }, { 0x60E8, 0x0010, 0 },
	{ 0x60E9, 0x2E06, 0 }, { 0x60EA, 0x1803, 0 }, { 0x60E8, 0x0011, 0 },
	{ 0x60EA, 0x1903, 0 }, { 0x60E8, 0x0012, 0 }, { 0x60E9, 0x3006, 0 },
	{ 0x60EA, 0x1A03, 0 }, { 0x60E8, 0x0013, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1B03, 0 }, { 0x60E8, 0x0014, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1C03, 0 }, { 0x60E8, 0x0015, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1D03, 0 }, { 0x60E8, 0x0016, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1E03, 0 }, { 0x60E8, 0x0017, 0 }, { 0x60E9, 0x3106, 0 },
	{ 0x60EA, 0x1F03, 0 }, { 0x60E8, 0x0018, 0 }, { 0x60E9, 0x3206, 0 },
	{ 0x60EA, 0x2003, 0 }, { 0x60E8, 0x0019, 0 }, { 0x60E9, 0x3306, 0 },
	{ 0x60EA, 0x2103, 0 }, { 0x60E8, 0x001A, 0 }, { 0x60E9, 0x3606, 0 },
	{ 0x60EA, 0x2203, 0 }, { 0x60E8, 0x001B, 0 }, { 0x60E9, 0x3906, 0 },
	{ 0x60EA, 0x2303, 0 }, { 0x60E8, 0x001C, 0 }, { 0x60E9, 0x3B06, 0 },
	{ 0x60EA, 0x2403, 0 }, { 0x60E8, 0x001D, 0 }, { 0x60E9, 0x3F06, 0 },
	{ 0x60EA, 0x2603, 0 }, { 0x60E8, 0x001E, 0 }, { 0x60E9, 0x4306, 0 },
	{ 0x60EA, 0x2803, 0 }, { 0x60E8, 0x001F, 0 }, { 0x60E9, 0x4706, 0 },
	{ 0x60EA, 0x2A03, 0 }, { 0x60F5, 0x1560, 0 }, { 0x60F8, 0x1560, 0 },
	{ 0x60FA, 0x00BC, 0 }, { 0x60FB, 0x00A6, 0 }, { 0x60FC, 0x01B6, 0 },
	{ 0x60FF, 0x0333, 0 }, { 0x6100, 0x0738, 0 }, { 0x6101, 0x0665, 0 },
	{ 0x6102, 0x09AC, 0 }, { 0x6103, 0x0888, 0 }, { 0x6104, 0x0CDD, 0 },
	{ 0x6105, 0x0888, 0 }, { 0x6106, 0x0CDD, 0 }, { 0x6107, 0x0888, 0 },
	{ 0x6108, 0x0CDD, 0 }, { 0x6109, 0x0888, 0 }, { 0x610A, 0x0CDD, 0 },
	{ 0x610B, 0x0599, 0 }, { 0x610C, 0x0DFE, 0 }, { 0x610E, 0x0599, 0 },
	{ 0x610F, 0x0DEE, 0 }, { 0x6111, 0x28FF, 0 }, { 0x6117, 0x1D3A, 0 },
	{ 0x6118, 0x1B36, 0 }, { 0x611B, 0x000F, 0 }, { 0x611C, 0x0002, 0 },
	{ 0x611D, 0x0002, 0 }, { 0x611E, 0x003C, 0 }, { 0x6121, 0x001F, 0 },
	{ 0x6122, 0x1CE7, 0 }, { 0x6123, 0x1D67, 0 }, { 0x6128, 0x03F4, 0 },
	{ 0x614C, 0x0E04, 0 }, { 0x614D, 0x0101, 0 }, { 0x6150, 0x005A, 0 },
	{ 0x6153, 0x6A10, 0 }, { 0x6154, 0x0080, 0 }, { 0x6155, 0x0002, 0 },
	{ 0x6156, 0x0F21, 0 }, { 0x6157, 0x1F21, 0 }, { 0x6161, 0x0023, 0 },
	{ 0x617E, 0x0B24, 0 }, { 0x6190, 0x003F, 0 }, { 0x61F8, 0x0551, 0 },
	{ 0x61F9, 0x0022, 0 }, { 0x61FA, 0x0010, 0 }, { 0x61FB, 0x0010, 0 },
	{ 0x61FC, 0x0008, 0 }, { 0x61FE, 0x795B, 0 }
};

static const struct reg_sequence pcie_x211[] = {
	{ 0xC003, 0x0144, 0 }, { 0xC00E, 0x0012, 0 }, { 0xE000, 0x0040, 0 },
	{ 0x0098, 0x2100, 0 }, { 0x0050, 0x8804, 0 }, { 0x0062, 0x1219, 0 },
	{ 0x00E2, 0x1912, 0 }, { 0x6002, 0x55A0, 0 }, { 0x6003, 0x691f, 0 },
	{ 0x600C, 0x001D, 0 }, { 0x603B, 0x0050, 0 }, { 0x604B, 0x0143, 0 },
	{ 0x6081, 0x813E, 0 }, { 0x6083, 0x4000, 0 }, { 0x6085, 0x1978, 0 },
	{ 0x6086, 0x0389, 0 }, { 0x6088, 0x038C, 0 }, { 0x608E, 0x3A7A, 0 },
	{ 0x6091, 0x033C, 0 }, { 0x6093, 0x0000, 0 }, { 0x6096, 0x0003, 0 },
	{ 0x6097, 0x22CC, 0 }, { 0x60AA, 0x7FF6, 0 }, { 0x60AB, 0x7FF6, 0 },
	{ 0x60B0, 0x7FBF, 0 }, { 0x60B1, 0x7FBF, 0 }, { 0x60B2, 0x7FD8, 0 },
	{ 0x60D4, 0x8C67, 0 }, { 0x60D5, 0x8C67, 0 }, { 0x60DE, 0x2437, 0 },
	{ 0x60E2, 0x3C2C, 0 }, { 0x60E8, 0x0000, 0 }, { 0x60EA, 0x0203, 0 },
	{ 0x60E8, 0x0001, 0 }, { 0x60EA, 0x0403, 0 }, { 0x60E8, 0x0002, 0 },
	{ 0x60EA, 0x0603, 0 }, { 0x60E8, 0x0003, 0 }, { 0x60EA, 0x0803, 0 },
	{ 0x60E8, 0x0004, 0 }, { 0x60EA, 0x0A03, 0 }, { 0x60E8, 0x0005, 0 },
	{ 0x60EA, 0x0C03, 0 }, { 0x60E8, 0x0006, 0 }, { 0x60EA, 0x0E03, 0 },
	{ 0x60E8, 0x0007, 0 }, { 0x60EA, 0x0F03, 0 }, { 0x60E8, 0x0008, 0 },
	{ 0x60EA, 0x1003, 0 }, { 0x60E8, 0x0009, 0 }, { 0x60EA, 0x1103, 0 },
	{ 0x60E8, 0x000A, 0 }, { 0x60E9, 0x1E06, 0 }, { 0x60EA, 0x1203, 0 },
	{ 0x60E8, 0x000B, 0 }, { 0x60EA, 0x1303, 0 }, { 0x60E8, 0x000C, 0 },
	{ 0x60EA, 0x1403, 0 }, { 0x60E8, 0x000D, 0 }, { 0x60EA, 0x1503, 0 },
	{ 0x60E8, 0x000E, 0 }, { 0x60E9, 0x2A06, 0 }, { 0x60EA, 0x1603, 0 },
	{ 0x60E8, 0x000F, 0 }, { 0x60E9, 0x2D06, 0 }, { 0x60EA, 0x1703, 0 },
	{ 0x60E8, 0x0010, 0 }, { 0x60E9, 0x2E06, 0 }, { 0x60EA, 0x1803, 0 },
	{ 0x60E8, 0x0011, 0 }, { 0x60EA, 0x1903, 0 }, { 0x60E8, 0x0012, 0 },
	{ 0x60E9, 0x3006, 0 }, { 0x60EA, 0x1A03, 0 }, { 0x60E8, 0x0013, 0 },
	{ 0x60E9, 0x3106, 0 }, { 0x60EA, 0x1B03, 0 }, { 0x60E8, 0x0014, 0 },
	{ 0x60E9, 0x3106, 0 }, { 0x60EA, 0x1C03, 0 }, { 0x60E8, 0x0015, 0 },
	{ 0x60E9, 0x3106, 0 }, { 0x60EA, 0x1D03, 0 }, { 0x60E8, 0x0016, 0 },
	{ 0x60E9, 0x3106, 0 }, { 0x60EA, 0x1E03, 0 }, { 0x60E8, 0x0017, 0 },
	{ 0x60E9, 0x3106, 0 }, { 0x60EA, 0x1F03, 0 }, { 0x60E8, 0x0018, 0 },
	{ 0x60E9, 0x3206, 0 }, { 0x60EA, 0x2003, 0 }, { 0x60E8, 0x0019, 0 },
	{ 0x60E9, 0x3306, 0 }, { 0x60EA, 0x2103, 0 }, { 0x60E8, 0x001A, 0 },
	{ 0x60E9, 0x3606, 0 }, { 0x60EA, 0x2203, 0 }, { 0x60E8, 0x001B, 0 },
	{ 0x60E9, 0x3906, 0 }, { 0x60EA, 0x2303, 0 }, { 0x60E8, 0x001C, 0 },
	{ 0x60E9, 0x3B06, 0 }, { 0x60EA, 0x2403, 0 }, { 0x60E8, 0x001D, 0 },
	{ 0x60E9, 0x3F06, 0 }, { 0x60EA, 0x2603, 0 }, { 0x60E8, 0x001E, 0 },
	{ 0x60E9, 0x4306, 0 }, { 0x60EA, 0x2803, 0 }, { 0x60E8, 0x001F, 0 },
	{ 0x60E9, 0x4706, 0 }, { 0x60EA, 0x2A03, 0 }, { 0x60F5, 0x1560, 0 },
	{ 0x60F8, 0x1560, 0 }, { 0x60FA, 0x00BC, 0 }, { 0x60FB, 0x00A6, 0 },
	{ 0x60FC, 0x01B6, 0 }, { 0x60FF, 0x0333, 0 }, { 0x6100, 0x0738, 0 },
	{ 0x6101, 0x0665, 0 }, { 0x6102, 0x09AC, 0 }, { 0x6103, 0x0888, 0 },
	{ 0x6104, 0x0CDD, 0 }, { 0x6105, 0x0888, 0 }, { 0x6106, 0x0CDD, 0 },
	{ 0x6107, 0x0888, 0 }, { 0x6108, 0x0CDD, 0 }, { 0x6109, 0x0888, 0 },
	{ 0x610A, 0x0CDD, 0 }, { 0x610B, 0x0599, 0 }, { 0x610C, 0x0DFE, 0 },
	{ 0x610E, 0x0599, 0 }, { 0x610F, 0x0DEE, 0 }, { 0x6111, 0x28FF, 0 },
	{ 0x6117, 0x1D3A, 0 }, { 0x6118, 0x1B36, 0 }, { 0x611B, 0x000F, 0 },
	{ 0x611C, 0x0002, 0 }, { 0x611D, 0x0002, 0 }, { 0x611E, 0x003C, 0 },
	{ 0x6121, 0x001F, 0 }, { 0x6122, 0x1CE7, 0 }, { 0x6123, 0x1D67, 0 },
	{ 0x6128, 0x03F4, 0 }, { 0x614C, 0x0E04, 0 }, { 0x614D, 0x0101, 0 },
	{ 0x6150, 0x005A, 0 }, { 0x6153, 0x6A10, 0 }, { 0x6154, 0x0080, 0 },
	{ 0x6155, 0x0002, 0 }, { 0x6156, 0x0F21, 0 }, { 0x6157, 0x1F21, 0 },
	{ 0x6161, 0x0023, 0 }, { 0x617E, 0x0B24, 0 }, { 0x6190, 0x003F, 0 },
	{ 0x61F8, 0x0551, 0 }, { 0x61F9, 0x0022, 0 }, { 0x61FA, 0x0010, 0 },
	{ 0x61FB, 0x0010, 0 }, { 0x61FC, 0x0008, 0 }, { 0x61FE, 0x795B, 0 },
	{ 0x6202, 0x55A0, 0 }, { 0x6203, 0x691f, 0 }, { 0x620C, 0x001D, 0 },
	{ 0x623B, 0x0050, 0 }, { 0x624B, 0x0143, 0 }, { 0x6281, 0x813E, 0 },
	{ 0x6283, 0x4000, 0 }, { 0x6285, 0x1978, 0 }, { 0x6286, 0x0389, 0 },
	{ 0x6288, 0x038C, 0 }, { 0x628E, 0x3A7A, 0 }, { 0x6291, 0x033C, 0 },
	{ 0x6293, 0x0000, 0 }, { 0x6296, 0x0003, 0 }, { 0x6297, 0x22CC, 0 },
	{ 0x62AA, 0x7FF6, 0 }, { 0x62AB, 0x7FF6, 0 }, { 0x62B0, 0x7FBF, 0 },
	{ 0x62B1, 0x7FBF, 0 }, { 0x62B2, 0x7FD8, 0 }, { 0x62D4, 0x8C67, 0 },
	{ 0x62D5, 0x8C67, 0 }, { 0x62DE, 0x2437, 0 }, { 0x62E2, 0x3C2C, 0 },
	{ 0x62E8, 0x0000, 0 }, { 0x62EA, 0x0203, 0 }, { 0x62E8, 0x0001, 0 },
	{ 0x62EA, 0x0403, 0 }, { 0x62E8, 0x0002, 0 }, { 0x62EA, 0x0603, 0 },
	{ 0x62E8, 0x0003, 0 }, { 0x62EA, 0x0803, 0 }, { 0x62E8, 0x0004, 0 },
	{ 0x62EA, 0x0A03, 0 }, { 0x62E8, 0x0005, 0 }, { 0x62EA, 0x0C03, 0 },
	{ 0x62E8, 0x0006, 0 }, { 0x62EA, 0x0E03, 0 }, { 0x62E8, 0x0007, 0 },
	{ 0x62EA, 0x0F03, 0 }, { 0x62E8, 0x0008, 0 }, { 0x62EA, 0x1003, 0 },
	{ 0x62E8, 0x0009, 0 }, { 0x62EA, 0x1103, 0 }, { 0x62E8, 0x000A, 0 },
	{ 0x62E9, 0x1E06, 0 }, { 0x62EA, 0x1203, 0 }, { 0x62E8, 0x000B, 0 },
	{ 0x62EA, 0x1303, 0 }, { 0x62E8, 0x000C, 0 }, { 0x62EA, 0x1403, 0 },
	{ 0x62E8, 0x000D, 0 }, { 0x62EA, 0x1503, 0 }, { 0x62E8, 0x000E, 0 },
	{ 0x62E9, 0x2A06, 0 }, { 0x62EA, 0x1603, 0 }, { 0x62E8, 0x000F, 0 },
	{ 0x62E9, 0x2D06, 0 }, { 0x62EA, 0x1703, 0 }, { 0x62E8, 0x0010, 0 },
	{ 0x62E9, 0x2E06, 0 }, { 0x62EA, 0x1803, 0 }, { 0x62E8, 0x0011, 0 },
	{ 0x62EA, 0x1903, 0 }, { 0x62E8, 0x0012, 0 }, { 0x62E9, 0x3006, 0 },
	{ 0x62EA, 0x1A03, 0 }, { 0x62E8, 0x0013, 0 }, { 0x62E9, 0x3106, 0 },
	{ 0x62EA, 0x1B03, 0 }, { 0x62E8, 0x0014, 0 }, { 0x62E9, 0x3106, 0 },
	{ 0x62EA, 0x1C03, 0 }, { 0x62E8, 0x0015, 0 }, { 0x62E9, 0x3106, 0 },
	{ 0x62EA, 0x1D03, 0 }, { 0x62E8, 0x0016, 0 }, { 0x62E9, 0x3106, 0 },
	{ 0x62EA, 0x1E03, 0 }, { 0x62E8, 0x0017, 0 }, { 0x62E9, 0x3106, 0 },
	{ 0x62EA, 0x1F03, 0 }, { 0x62E8, 0x0018, 0 }, { 0x62E9, 0x3206, 0 },
	{ 0x62EA, 0x2003, 0 }, { 0x62E8, 0x0019, 0 }, { 0x62E9, 0x3306, 0 },
	{ 0x62EA, 0x2103, 0 }, { 0x62E8, 0x001A, 0 }, { 0x62E9, 0x3606, 0 },
	{ 0x62EA, 0x2203, 0 }, { 0x62E8, 0x001B, 0 }, { 0x62E9, 0x3906, 0 },
	{ 0x62EA, 0x2303, 0 }, { 0x62E8, 0x001C, 0 }, { 0x62E9, 0x3B06, 0 },
	{ 0x62EA, 0x2403, 0 }, { 0x62E8, 0x001D, 0 }, { 0x62E9, 0x3F06, 0 },
	{ 0x62EA, 0x2603, 0 }, { 0x62E8, 0x001E, 0 }, { 0x62E9, 0x4306, 0 },
	{ 0x62EA, 0x2803, 0 }, { 0x62E8, 0x001F, 0 }, { 0x62E9, 0x4706, 0 },
	{ 0x62EA, 0x2A03, 0 }, { 0x62F5, 0x1560, 0 }, { 0x62F8, 0x1560, 0 },
	{ 0x62FA, 0x00BC, 0 }, { 0x62FB, 0x00A6, 0 }, { 0x62FC, 0x01B6, 0 },
	{ 0x62FF, 0x0333, 0 }, { 0x6300, 0x0738, 0 }, { 0x6301, 0x0665, 0 },
	{ 0x6302, 0x09AC, 0 }, { 0x6303, 0x0888, 0 }, { 0x6304, 0x0CDD, 0 },
	{ 0x6305, 0x0888, 0 }, { 0x6306, 0x0CDD, 0 }, { 0x6307, 0x0888, 0 },
	{ 0x6308, 0x0CDD, 0 }, { 0x6309, 0x0888, 0 }, { 0x630A, 0x0CDD, 0 },
	{ 0x630B, 0x0599, 0 }, { 0x630C, 0x0DFE, 0 }, { 0x630E, 0x0599, 0 },
	{ 0x630F, 0x0DEE, 0 }, { 0x6311, 0x28FF, 0 }, { 0x6317, 0x1D3A, 0 },
	{ 0x6318, 0x1B36, 0 }, { 0x631B, 0x000F, 0 }, { 0x631C, 0x0002, 0 },
	{ 0x631D, 0x0002, 0 }, { 0x631E, 0x003C, 0 }, { 0x6321, 0x001F, 0 },
	{ 0x6322, 0x1CE7, 0 }, { 0x6323, 0x1D67, 0 }, { 0x6328, 0x03F4, 0 },
	{ 0x634C, 0x0E04, 0 }, { 0x634D, 0x0101, 0 }, { 0x6350, 0x005A, 0 },
	{ 0x6353, 0x6A10, 0 }, { 0x6354, 0x0080, 0 }, { 0x6355, 0x0002, 0 },
	{ 0x6356, 0x0F21, 0 }, { 0x6357, 0x1F21, 0 }, { 0x6361, 0x0023, 0 },
	{ 0x637E, 0x0B24, 0 }, { 0x6390, 0x003F, 0 }, { 0x63F8, 0x0551, 0 },
	{ 0x63F9, 0x0022, 0 }, { 0x63FA, 0x0010, 0 }, { 0x63FB, 0x0010, 0 },
	{ 0x63FC, 0x0008, 0 }, { 0x63FE, 0x795B, 0 }, { 0x6402, 0x55A0, 0 },
	{ 0x6403, 0x691f, 0 }, { 0x640C, 0x001D, 0 }, { 0x643B, 0x0050, 0 },
	{ 0x644B, 0x0143, 0 }, { 0x6481, 0x813E, 0 }, { 0x6483, 0x4000, 0 },
	{ 0x6485, 0x1978, 0 }, { 0x6486, 0x0389, 0 }, { 0x6488, 0x038C, 0 },
	{ 0x648E, 0x3A7A, 0 }, { 0x6491, 0x033C, 0 }, { 0x6493, 0x0000, 0 },
	{ 0x6496, 0x0003, 0 }, { 0x6497, 0x22CC, 0 }, { 0x64AA, 0x7FF6, 0 },
	{ 0x64AB, 0x7FF6, 0 }, { 0x64B0, 0x7FBF, 0 }, { 0x64B1, 0x7FBF, 0 },
	{ 0x64B2, 0x7FD8, 0 }, { 0x64D4, 0x8C67, 0 }, { 0x64D5, 0x8C67, 0 },
	{ 0x64DE, 0x2437, 0 }, { 0x64E2, 0x3C2C, 0 }, { 0x64E8, 0x0000, 0 },
	{ 0x64EA, 0x0203, 0 }, { 0x64E8, 0x0001, 0 }, { 0x64EA, 0x0403, 0 },
	{ 0x64E8, 0x0002, 0 }, { 0x64EA, 0x0603, 0 }, { 0x64E8, 0x0003, 0 },
	{ 0x64EA, 0x0803, 0 }, { 0x64E8, 0x0004, 0 }, { 0x64EA, 0x0A03, 0 },
	{ 0x64E8, 0x0005, 0 }, { 0x64EA, 0x0C03, 0 }, { 0x64E8, 0x0006, 0 },
	{ 0x64EA, 0x0E03, 0 }, { 0x64E8, 0x0007, 0 }, { 0x64EA, 0x0F03, 0 },
	{ 0x64E8, 0x0008, 0 }, { 0x64EA, 0x1003, 0 }, { 0x64E8, 0x0009, 0 },
	{ 0x64EA, 0x1103, 0 }, { 0x64E8, 0x000A, 0 }, { 0x64E9, 0x1E06, 0 },
	{ 0x64EA, 0x1203, 0 }, { 0x64E8, 0x000B, 0 }, { 0x64EA, 0x1303, 0 },
	{ 0x64E8, 0x000C, 0 }, { 0x64EA, 0x1403, 0 }, { 0x64E8, 0x000D, 0 },
	{ 0x64EA, 0x1503, 0 }, { 0x64E8, 0x000E, 0 }, { 0x64E9, 0x2A06, 0 },
	{ 0x64EA, 0x1603, 0 }, { 0x64E8, 0x000F, 0 }, { 0x64E9, 0x2D06, 0 },
	{ 0x64EA, 0x1703, 0 }, { 0x64E8, 0x0010, 0 }, { 0x64E9, 0x2E06, 0 },
	{ 0x64EA, 0x1803, 0 }, { 0x64E8, 0x0011, 0 }, { 0x64EA, 0x1903, 0 },
	{ 0x64E8, 0x0012, 0 }, { 0x64E9, 0x3006, 0 }, { 0x64EA, 0x1A03, 0 },
	{ 0x64E8, 0x0013, 0 }, { 0x64E9, 0x3106, 0 }, { 0x64EA, 0x1B03, 0 },
	{ 0x64E8, 0x0014, 0 }, { 0x64E9, 0x3106, 0 }, { 0x64EA, 0x1C03, 0 },
	{ 0x64E8, 0x0015, 0 }, { 0x64E9, 0x3106, 0 }, { 0x64EA, 0x1D03, 0 },
	{ 0x64E8, 0x0016, 0 }, { 0x64E9, 0x3106, 0 }, { 0x64EA, 0x1E03, 0 },
	{ 0x64E8, 0x0017, 0 }, { 0x64E9, 0x3106, 0 }, { 0x64EA, 0x1F03, 0 },
	{ 0x64E8, 0x0018, 0 }, { 0x64E9, 0x3206, 0 }, { 0x64EA, 0x2003, 0 },
	{ 0x64E8, 0x0019, 0 }, { 0x64E9, 0x3306, 0 }, { 0x64EA, 0x2103, 0 },
	{ 0x64E8, 0x001A, 0 }, { 0x64E9, 0x3606, 0 }, { 0x64EA, 0x2203, 0 },
	{ 0x64E8, 0x001B, 0 }, { 0x64E9, 0x3906, 0 }, { 0x64EA, 0x2303, 0 },
	{ 0x64E8, 0x001C, 0 }, { 0x64E9, 0x3B06, 0 }, { 0x64EA, 0x2403, 0 },
	{ 0x64E8, 0x001D, 0 }, { 0x64E9, 0x3F06, 0 }, { 0x64EA, 0x2603, 0 },
	{ 0x64E8, 0x001E, 0 }, { 0x64E9, 0x4306, 0 }, { 0x64EA, 0x2803, 0 },
	{ 0x64E8, 0x001F, 0 }, { 0x64E9, 0x4706, 0 }, { 0x64EA, 0x2A03, 0 },
	{ 0x64F5, 0x1560, 0 }, { 0x64F8, 0x1560, 0 }, { 0x64FA, 0x00BC, 0 },
	{ 0x64FB, 0x00A6, 0 }, { 0x64FC, 0x01B6, 0 }, { 0x64FF, 0x0333, 0 },
	{ 0x6500, 0x0738, 0 }, { 0x6501, 0x0665, 0 }, { 0x6502, 0x09AC, 0 },
	{ 0x6503, 0x0888, 0 }, { 0x6504, 0x0CDD, 0 }, { 0x6505, 0x0888, 0 },
	{ 0x6506, 0x0CDD, 0 }, { 0x6507, 0x0888, 0 }, { 0x6508, 0x0CDD, 0 },
	{ 0x6509, 0x0888, 0 }, { 0x650A, 0x0CDD, 0 }, { 0x650B, 0x0599, 0 },
	{ 0x650C, 0x0DFE, 0 }, { 0x650E, 0x0599, 0 }, { 0x650F, 0x0DEE, 0 },
	{ 0x6511, 0x28FF, 0 }, { 0x6517, 0x1D3A, 0 }, { 0x6518, 0x1B36, 0 },
	{ 0x651B, 0x000F, 0 }, { 0x651C, 0x0002, 0 }, { 0x651D, 0x0002, 0 },
	{ 0x651E, 0x003C, 0 }, { 0x6521, 0x001F, 0 }, { 0x6522, 0x1CE7, 0 },
	{ 0x6523, 0x1D67, 0 }, { 0x6528, 0x03F4, 0 }, { 0x654C, 0x0E04, 0 },
	{ 0x654D, 0x0101, 0 }, { 0x6550, 0x005A, 0 }, { 0x6553, 0x6A10, 0 },
	{ 0x6554, 0x0080, 0 }, { 0x6555, 0x0002, 0 }, { 0x6556, 0x0F21, 0 },
	{ 0x6557, 0x1F21, 0 }, { 0x6561, 0x0023, 0 }, { 0x657E, 0x0B24, 0 },
	{ 0x6590, 0x003F, 0 }, { 0x65F8, 0x0551, 0 }, { 0x65F9, 0x0022, 0 },
	{ 0x65FA, 0x0010, 0 }, { 0x65FB, 0x0010, 0 }, { 0x65FC, 0x0008, 0 },
	{ 0x65FE, 0x795B, 0 }
};

struct cix_phy_instance {
	struct phy *phy;
	u32 num_lanes;
	u32 mlane;
	u32 status;
};

struct cix_pcie_phy {
	struct device *dev;
	void __iomem *base;
	struct regmap *phy_regmap;
	int nsubnodes;
	u32 num_lanes;
	int already_configured;//global, common layer, not special to any link
	int powered;
	struct clk *apb_clk;
	struct clk *refclk;
	struct cix_phy_instance phy_instances[MAX_LANES];
	struct mutex mutex;
};

static int pcie_phy_regmap_write(void *context, unsigned int reg, unsigned int val)
{
#if (!IS_ENABLED(CONFIG_ARCH_CIX_EMU_FPGA))
	struct cix_pcie_phy *pcie_phy = context;
	u32 offset = reg << 2;

	writel(val, pcie_phy->base + offset);
#endif

	return 0;
}

static int pcie_phy_regmap_read(void *context, unsigned int reg, unsigned int *val)
{
#if (!IS_ENABLED(CONFIG_ARCH_CIX_EMU_FPGA))
	struct cix_pcie_phy *pcie_phy = context;
	u32 offset = reg << 2;

	*val = readl(pcie_phy->base + offset);
#endif

	return 0;
}

static const struct regmap_config cix_udphy_regmap_cfg = {
	.reg_bits = 32,
	.reg_stride = 1,//register width, if =2, then only reg 0 2 4 ...2^n can access
	.val_bits = 16,
	.fast_io = true,
	.reg_write = pcie_phy_regmap_write,
	.reg_read = pcie_phy_regmap_read,
};

static int pcie_phy_common_init(struct cix_pcie_phy *pcie_phy)
{
	int ret;

	if (pcie_phy->num_lanes == X8) {
		ret = regmap_multi_reg_write(pcie_phy->phy_regmap, pcie_x8, ARRAY_SIZE(pcie_x8));
	} else if (pcie_phy->num_lanes == X4 && (pcie_phy->nsubnodes == 1)) {
		ret = regmap_multi_reg_write(pcie_phy->phy_regmap, pcie_x4, ARRAY_SIZE(pcie_x4));
	} else if (pcie_phy->num_lanes == X4) {
		ret = regmap_multi_reg_write(pcie_phy->phy_regmap, pcie_x211, ARRAY_SIZE(pcie_x211));
	} else {
		dev_err(pcie_phy->dev, "Invalid Phy Config\n");
	}

	if (ret) {
		dev_err(pcie_phy->dev, "Failed to write the reg sequence\n");
	} else {
		pcie_phy->already_configured = 1;
	}

	dev_info(pcie_phy->dev, "%s end \n", __func__);
	return ret;
}

static int pcie_phy_common_exit(struct cix_pcie_phy *pcie_phy)
{
	clk_disable_unprepare(pcie_phy->refclk);
	clk_disable_unprepare(pcie_phy->apb_clk);

	pcie_phy->already_configured = 0;
	pcie_phy->powered = 0;

	dev_info(pcie_phy->dev, "%s end\n", __func__);
	return 0;
}

static int pcie_phy_link_enable (struct cix_phy_instance *ins)
{
	ins->status = LINK_ENABLED;
	return 0;
}

static int pcie_phy_link_disable (struct cix_phy_instance *ins)
{
	ins->status = LINK_DISABLED;
	return 0;
}

static int pcie_phy_power_on(struct phy *phy)
{
	struct cix_phy_instance *ins = phy_get_drvdata(phy);
	struct cix_pcie_phy *pcie_phy = dev_get_drvdata(phy->dev.parent);
	int ret;

	mutex_lock(&pcie_phy->mutex);

	if (!pcie_phy->already_configured) {
		ret = pcie_phy_common_init(pcie_phy);

		if (ret)
			goto unlock;
	}

	if (pcie_phy->nsubnodes <= 1) {
		goto unlock;
	}

	//TODO Implement Link Enable
	ret = pcie_phy_link_enable(ins);

unlock:
	mutex_unlock(&pcie_phy->mutex);

	return ret;
}

static int pcie_phy_exit(struct phy *phy)
{
	struct cix_phy_instance *ins = phy_get_drvdata(phy);
	struct cix_pcie_phy *pcie_phy = dev_get_drvdata(phy->dev.parent);
	int Index, ret;

	mutex_lock(&pcie_phy->mutex);
	//TODO Implement Link Disable
	if (pcie_phy->nsubnodes > 1) {
		ret = pcie_phy_link_disable(ins);
		if (ret)
			goto unlock;
	}

	for(Index =0 ; Index < pcie_phy->nsubnodes; Index++) {
		if (pcie_phy->phy_instances[Index].status == LINK_ENABLED) {
			break;
		}
	}

	if (Index == pcie_phy->nsubnodes && pcie_phy->already_configured) {
		pcie_phy_common_exit(pcie_phy);
	}

unlock:
	mutex_unlock(&pcie_phy->mutex);

	return ret;
}

static int pcie_phy_init(struct phy *phy)
{
	struct cix_pcie_phy *pcie_phy = dev_get_drvdata(phy->dev.parent);
	int ret;

	mutex_lock(&pcie_phy->mutex);
	if (!pcie_phy->powered) {
		//clock enable
		ret = clk_prepare_enable(pcie_phy->apb_clk);
		if (ret) {
			dev_err(pcie_phy->dev, "Failed to prepare_enable pcie apb clock\n");
			goto unlock;
		}

		ret = clk_prepare_enable(pcie_phy->refclk);
		if (ret) {
			dev_err(pcie_phy->dev, "Failed to prepare_enable pcie refclk clock\n");
			clk_disable_unprepare(pcie_phy->apb_clk);
			goto unlock;
		}

		pcie_phy->powered = 1;
	}

unlock:
	mutex_unlock(&pcie_phy->mutex);

	return 0;
}

static const struct phy_ops ops = {
	.power_on = pcie_phy_power_on,
	.init		= pcie_phy_init,
	.exit	= pcie_phy_exit,
	.owner		= THIS_MODULE,
};

static int cix_pcie_phy_get_instance (struct cix_phy_instance *inst,
			struct fwnode_handle *child)
{
	if (fwnode_property_read_u32(child, "reg", &inst->mlane))
		return -EINVAL;

	if (fwnode_property_read_u32(child, "num-lanes", &inst->num_lanes))
		return -EINVAL;

	return 0;
}

static int cix_pcie_phy_probe(struct platform_device *pdev)
{
	struct cix_pcie_phy *pcie_phy;
	struct device *dev = &pdev->dev;
	struct phy_provider *phy_provider;
	struct fwnode_handle *child;
	int ret, node = 0;

	if (device_get_child_node_count(dev) == 0)
		return -ENODEV;

	pcie_phy = devm_kzalloc(dev, sizeof(*pcie_phy), GFP_KERNEL);
	if (!pcie_phy)
		return -ENOMEM;
	
	dev_set_drvdata(dev, pcie_phy);
	pcie_phy->dev = dev;

	pcie_phy->apb_clk = devm_clk_get(dev, "pclk");
	if (IS_ERR(pcie_phy->apb_clk)) {
		dev_err(dev, "phy apb clock not found\n");
		return PTR_ERR(pcie_phy->apb_clk);
	}

	pcie_phy->refclk = devm_clk_get(dev, "refclk");
	if (IS_ERR(pcie_phy->refclk)) {
		dev_err(dev, "phy refclk not found\n");
		return PTR_ERR(pcie_phy->refclk);
	}

	pcie_phy->base = devm_platform_ioremap_resource(pdev, 0);
	if (IS_ERR(pcie_phy->base)) {
		dev_err(dev, "missing \"reg\"\n");
		return PTR_ERR(pcie_phy->base);
	}

	pcie_phy->phy_regmap = devm_regmap_init(dev, NULL, pcie_phy, &cix_udphy_regmap_cfg);
	if (IS_ERR(pcie_phy->phy_regmap)) {
		dev_err(dev, "failed to remap phy register\n");
		return PTR_ERR(pcie_phy->phy_regmap);
	}

	mutex_init(&pcie_phy->mutex);

	device_for_each_child_node(dev, child) {
		struct phy *gphy;

		ret = cix_pcie_phy_get_instance(&pcie_phy->phy_instances[node], child);
		if (ret) {
			dev_err(dev, "missing property in node %s\n",
				fwnode_get_name(child));
				goto put_child;
		}

		pcie_phy->num_lanes += pcie_phy->phy_instances[node].num_lanes;
		gphy = devm_phy_create(dev, to_of_node(child), &ops);

		if (IS_ERR(gphy)) {
			ret = PTR_ERR(gphy);
			goto put_child;
		}

		pcie_phy->phy_instances[node].phy = gphy;
		phy_set_drvdata(gphy, &pcie_phy->phy_instances[node]);
		phy_create_lookup(gphy, fwnode_get_name(child), dev_name(dev));

		node++;
	}

	pcie_phy->nsubnodes = node;

	dev_info(dev, "nsubnodes = %d, num_lanes = %d\n", pcie_phy->nsubnodes, pcie_phy->num_lanes);

	if (pcie_phy->num_lanes > MAX_LANES) {
		ret = -EINVAL;
		dev_err(dev, "Invalid lane configuration\n");
		return ret;
	}

	phy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);
	if (IS_ERR(phy_provider)) {
		ret = PTR_ERR(phy_provider);
		return ret;
	}

	return 0;

put_child:
	fwnode_handle_put(child);
	return ret;
}

static const struct of_device_id cix_pcie_phy_dt_match[] = {
	{
		.compatible = "cix,sky1-pcie-phy",
		.data = NULL
	},
	{ /* sentinel */ }
};

static const struct acpi_device_id cix_pcie_phy_acpi_match[] = {
	{ "CIXH2023" },
	{},
};
MODULE_DEVICE_TABLE(acpi, cix_pcie_phy_acpi_match);

static struct platform_driver cix_pcie_phy_driver = {
	.probe		= cix_pcie_phy_probe,
	.driver		= {
		.name	= "cix-pcie-phy",
		.of_match_table = cix_pcie_phy_dt_match,
		.acpi_match_table = cix_pcie_phy_acpi_match,
		.pm = NULL,
	},
};

module_platform_driver(cix_pcie_phy_driver);

MODULE_AUTHOR("Chao Zeng <chao.zeng@cixteck.com>");
MODULE_DESCRIPTION("Cix PCIE PHY driver");
MODULE_LICENSE("GPL v2");
